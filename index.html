<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width, viewport-fit=cover">
    <title>æ·±åœ³è¡¥å…¨è®¡åˆ’ï¼ˆäº‘åŒæ­¥ç‰ˆï¼‰</title>
    <style>
        /* --- å…¨å±€è®¾ç½® --- */
        html, body, #container { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent;}
        .amap-logo, .amap-copyright { display: none !important; }

        /* --- å°é¢å±‚ --- */
        #cover-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000;
            background-image: url('Shenzhen_Map.png'); 
            background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-in-out;
        }
        #cover-title { color: white; font-size: 32px; font-weight: bold; text-shadow: 0 4px 10px rgba(0,0,0,0.5); text-align: center; }
        #cover-subtitle { color: rgba(255,255,255,0.8); font-size: 16px; margin-top: 10px; font-weight: normal; }

        /* --- åº•éƒ¨ä¸»é¢æ¿ (PCç«¯é»˜è®¤æ ·å¼) --- */
        #panel {
            position: absolute; bottom: 40px; left: 50%; 
            transform: translateX(-50%); z-index: 2001;
            background: rgba(255, 255, 255, 0.95); padding: 20px 25px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center;
            width: 85%; max-width: 360px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s; margin-bottom: env(safe-area-inset-bottom);
        }
        
        /* é¢æ¿å†…å®¹å®¹å™¨ */
        #panel-content h2 { margin: 0 0 5px 0; font-size: 18px; color: #333; }
        #status { margin-bottom: 15px; color: #666; font-size: 14px; min-height: 20px; line-height: 1.5; }

        /* é¢æ¿å†…è¯¦æƒ…æ ·å¼ (ä»…åœ¨æ‰‹æœºç«¯æ¿€æ´») */
        .panel-detail-name { font-size: 18px; font-weight: bold; color: #000; margin-bottom: 4px; }
        .panel-detail-address { font-size: 13px; color: #666; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .panel-tags { display: inline-block; font-size: 12px; color: #007AFF; background: #eef6ff; padding: 2px 6px; border-radius: 4px; margin-bottom: 10px; }
        
        /* æ‰‹æœºç«¯é¢æ¿é‡Œçš„åŠŸèƒ½æŒ‰é’®ç»„ */
        .panel-actions { display: flex; gap: 10px; margin-bottom: 12px; }
        .p-btn { flex: 1; padding: 8px 0; border: none; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 4px; }
        .p-btn-check { background: #34C759; color: white; }
        .p-btn-nav { background: #007AFF; color: white; }

        /* ä¸»å¤§æŒ‰é’® */
        button#btn {
            padding: 14px 0; background: linear-gradient(135deg, #007AFF, #0056b3);
            color: white; border: none; border-radius: 30px; 
            font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4); 
            transition: all 0.3s ease; width: 100%;
        }
        button#btn:active { transform: scale(0.96); box-shadow: 0 2px 5px rgba(0, 122, 255, 0.3); }
        button#btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* --- å¯¼èˆªèœå• --- */
        #nav-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); 
            z-index: 5999; 
            display: none; opacity: 0; transition: opacity 0.3s; 
        }

        #nav-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #f2f2f2; border-radius: 16px 16px 0 0;
            z-index: 6000; 
            display: none; transform: translateY(100%);
            padding-bottom: constant(safe-area-inset-bottom); 
            padding-bottom: env(safe-area-inset-bottom);
            overflow: hidden; box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
        }        
        
        #nav-sheet.open { display: block; animation: slideUp 0.3s forwards; }
        #nav-sheet.closing { display: block; animation: slideDown 0.3s forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        
        .nav-header { text-align: center; padding: 15px; color: #999; font-size: 13px; background: white; border-bottom: 1px solid #eee; }
        .nav-item { display: block; width: 100%; padding: 18px 0; background: white; border: none; border-bottom: 1px solid #f2f2f2; font-size: 18px; color: #007AFF; font-weight: 500; cursor: pointer; }
        .nav-item:active { background: #f9f9f9; }
        .nav-item.cancel { margin-top: 8px; font-weight: bold; border-bottom: none; color: #333; }
        #nav-overlay.open { display: block; opacity: 1; }

        /* --- æ§ä»¶ --- */
        #layer-control {
            position: absolute; top: 20px; left: 20px; z-index: 999;
            background: rgba(255, 255, 255, 0.9); padding: 5px;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; gap: 5px;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease;
        }
        .layer-btn { background: transparent; border: none; padding: 8px 12px; font-size: 14px; cursor: pointer; border-radius: 6px; color: #333; font-weight: bold; text-align: left; transition: all 0.2s; white-space: nowrap; }
        .layer-btn:hover { background: #eee; }
        .layer-btn.active { background: #007AFF; color: white; box-shadow: 0 2px 5px rgba(0, 122, 255, 0.3); }

        #right-controls {
            position: absolute; top: 20px; right: 20px; z-index: 999;
            display: flex; flex-direction: column; gap: 10px;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease;
        }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.9); box-shadow: 0 2px 10px rgba(0,0,0,0.2); border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 20px; }

        /* --- ç‚¹äº®å¤¹ä¾§è¾¹æ  (å¸¦åŒæ­¥è¾“å…¥æ¡†) --- */
        #collection-panel {
            position: absolute; top: 0; right: -100%; width: 100%; height: 100%; 
            max-width: 360px; background: rgba(255, 255, 255, 0.98);
            z-index: 5500; /* âœ… ä¿®æ”¹ï¼šæé«˜å±‚çº§ï¼Œå‹è¿‡æ‰‹æœºåº•éƒ¨é¢æ¿(5000) */
            padding: 20px; box-sizing: border-box; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: right 0.3s ease;
            display: flex; flex-direction: column; backdrop-filter: blur(10px);
            padding-top: max(20px, env(safe-area-inset-top)); 
        }        
        
        #collection-panel.open { right: 0; }
        .col-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .col-title { font-size: 18px; font-weight: bold; color: #333; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 10px; }
        
        /* åŒæ­¥æ¡†æ ·å¼ */
        .sync-box { background:#f0f0f0; padding:12px; border-radius:8px; margin-bottom:15px; font-size:13px; }
        .sync-label { margin-bottom:8px; color:#666; font-weight:500; display:flex; justify-content:space-between; }
        .sync-input-group { display:flex; gap:8px; }
        .sync-input { flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; text-align:center; font-family:monospace; font-weight:bold; outline:none; }
        .sync-btn { padding:0 15px; background:#007AFF; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }

        #col-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .col-item {
            background: #f9f9f9; border-radius: 10px; padding: 12px; margin-bottom: 12px;
            border-left: 4px solid #FFD700; display: flex; justify-content: space-between; align-items: center;
        }
        .col-info { flex: 1; margin-right: 10px; overflow: hidden; }
        .col-info h4 { margin: 0 0 5px 0; font-size: 15px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .col-info p { margin: 0; font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .col-info .date { font-size: 10px; color: #999; margin-top: 5px; display: block;}
        .col-actions { display: flex; gap: 8px; align-items: center; }
        .action-btn { width: 32px; height: 32px; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; font-size: 16px; cursor: pointer; }
        .btn-fly { background: #E1F5FE; color: #007AFF; }
        .btn-nav-col { background: #E8F5E9; color: #34C759; }
        .btn-del { background: #FFEBEE; color: #FF3B30; }

        /* --- å°åœ°å›¾ --- */
        #mini-map {
            position: absolute; bottom: 30px; right: 20px; 
            width: 160px; height: 120px; z-index: 990; 
            border-radius: 8px; border: 2px solid rgba(255, 255, 255, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background: #2b2b2b; overflow: hidden;
            visibility: hidden; opacity: 0;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        #mini-map .amap-logo, #mini-map .amap-copyright { display: none !important; }

        /* æ ‡è®°ç‚¹ */
        .custom-marker { background-color: #007AFF; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); position: relative; }
        .custom-marker::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; background-color: rgba(0, 122, 255, 0.6); border-radius: 50%; animation: pulse 1.5s infinite; z-index: -1; }
        .lit-marker { background-color: #FFD700; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); z-index: 50; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; } 100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; } }
        .mini-marker { background-color: #FF3B30; width: 8px; height: 8px; border-radius: 50%; border: 1.5px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .mini-lit-marker { background-color: #FFD700; width: 3px; height: 3px; border-radius: 50%; } 

        /* ç”µè„‘ç«¯çš„Info Window æŒ‰é’® */
        .bubble-btn-group { display: flex; gap: 8px; margin-top: 10px; }
        .bubble-btn { flex: 1; border: none; padding: 8px 0; border-radius: 8px; font-size: 13px; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; }
        .btn-checkin { background: #34C759; } 
        .btn-checkin:hover { background: #2DAF4F; }
        .btn-nav { background: #007AFF; }
        .btn-nav:hover { background: #0062CC; }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media screen and (max-width: 600px) {
            #layer-control { top: calc(env(safe-area-inset-top) + 15px); left: 15px; flex-direction: row; padding: 4px; }
            .layer-btn { padding: 6px 10px; font-size: 12px; }
            #right-controls { top: calc(env(safe-area-inset-top) + 15px); right: 15px; }
            .icon-btn { width: 36px; height: 36px; font-size: 18px; }
            #mini-map { display: none !important; }
            
            #panel { 
                width: 90%; 
                padding: 15px 20px; 
                bottom: 15px; 
                border-radius: 16px;
                z-index: 5000; 
            }
            button#btn { padding: 10px 0; font-size: 16px; border-radius: 20px; }
            .amap-info-content-container { display: none !important; }
            .amap-info-sharp { display: none !important; }
        }
    </style>
    
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '6e074a0b1eb86ef3fcbb0863a843a608',
        };
    </script>

    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=abbb06ea6f70500caeec5801b256357d&plugin=AMap.DistrictSearch,AMap.GeometryUtil,AMap.PlaceSearch,AMap.Scale"></script>
    
    <script src="Bmob.js"></script>

</head>  
<body>

<div id="cover-layer">
    <div style="text-align:center">
        <div id="cover-title">æ·±åœ³è¡¥å…¨è®¡åˆ’</div>
        <div id="cover-subtitle">Discover Shenzhen</div>
    </div>
</div>

<div id="container"></div>

<div id="nav-overlay" onclick="closeNavSheet()"></div>
<div id="nav-sheet">
    <div class="nav-header">å¯¼èˆªåˆ°ç›®çš„åœ°</div>
    <button class="nav-item" onclick="startNavigation('amap')">é«˜å¾·åœ°å›¾ (æ¨è)</button>
    <button class="nav-item" onclick="startNavigation('apple')">Apple åœ°å›¾</button>
    <button class="nav-item cancel" onclick="closeNavSheet()">å–æ¶ˆ</button>
</div>

<div id="layer-control">
    <button class="layer-btn active" onclick="switchMapStyle('satellite', this)">å«æ˜Ÿ</button>
    <button class="layer-btn" onclick="switchMapStyle('normal', this)">æ ‡å‡†</button>
    <button class="layer-btn" onclick="switchMapStyle('traffic', this)">è·¯å†µ</button>
</div>

<div id="right-controls">
    <button class="icon-btn" onclick="toggleCollection()" title="ç‚¹äº®å¤¹">ğŸŒŸ</button>
</div>

<div id="collection-panel">
    <div class="col-header">
        <div class="col-title">æˆ‘çš„ç‚¹äº®è¶³è¿¹</div>
        <button class="close-btn" onclick="toggleCollection()">Ã—</button>
    </div>
    
    <div class="sync-box">
        <div class="sync-label">
            <span>â˜ï¸ å¤šç«¯åŒæ­¥ç </span>
            <span id="sync-status" style="font-weight:normal;color:#007AFF">æœªè¿æ¥</span>
        </div>
        <div class="sync-input-group">
            <input type="text" id="sync-code-input" class="sync-input" placeholder="è¾“å…¥åŒæ­¥ç ">
            <button class="sync-btn" onclick="updateSyncCode()">åŒæ­¥</button>
        </div>
        <div style="margin-top:5px; color:#999; font-size:11px;">åœ¨æ‰‹æœºå’Œç”µè„‘è¾“å…¥ç›¸åŒçš„ç (å¦‚: sz666)å³å¯åŒæ­¥æ•°æ®</div>
    </div>

    <div id="col-list"></div>
</div>

<div id="mini-map"></div>

<div id="panel">
    <div id="panel-content">
        <h2>æ·±åœ³å»å“ªç©ï¼Ÿ</h2>
        <div id="status">æ­£åœ¨å‡†å¤‡æ•°æ®...</div>
    </div>
    <button id="btn" onclick="onFirstClick()" disabled>å‡†å¤‡ä¸­...</button>
</div>

<script>
    // --- 1. Bmob åˆå§‹åŒ– (äº‘ç«¯æ•°æ®åº“) ---
    // å¯†é’¥æ¥è‡ªä½ çš„é…ç½®ï¼Œå®‰å…¨ç è®¾ä¸º 123456
    Bmob.initialize("4479267291201ee6", "123456");

    // --- 2. åŒæ­¥ç é€»è¾‘ ---
    let userSyncCode = localStorage.getItem('sz_sync_code') || 'guest_' + Math.random().toString(36).substr(2, 6);
    localStorage.setItem('sz_sync_code', userSyncCode);
    
    // ç¼“å­˜æ•°æ®
    let cachedList = [];

    // --- é¡µé¢é€»è¾‘å¼€å§‹ ---
    var isFirstStart = true;
    
    var standardLayer = new AMap.TileLayer();
    var satelliteLayer = new AMap.TileLayer.Satellite();
    var roadNetLayer = new AMap.TileLayer.RoadNet();
    var trafficLayer = new AMap.TileLayer.Traffic({ zIndex: 10 });

    var map = new AMap.Map('container', {
        zoom: 11, center: [114.057868, 22.543099],
        viewMode: '3D', pitch: 0,
        layers: [satelliteLayer, roadNetLayer] 
    });
    
    if (window.innerWidth > 600) {
        map.addControl(new AMap.Scale());
    }

    var miniMap = new AMap.Map('mini-map', {
        viewMode: '2D', mapStyle: 'amap://styles/grey',
        zoomEnable: false, dragEnable: false,
        scrollWheel: false, doubleClickZoom: false, keyboardEnable: false
    });

    var currentMarker = null; var miniMarker = null;
    var currentTargetData = null; var navTargetData = null;
    var litMarkers = []; var miniLitMarkers = []; 
    var shenzhenPolygons = []; var mainPolygons = []; var miniPolygons = []; 

    // åˆå§‹åŒ–åŠ è½½
    window.addEventListener('load', () => {
        // 1. å¡«å……åŒæ­¥ç 
        document.getElementById('sync-code-input').value = userSyncCode;
        // 2. å°è¯•ä»äº‘ç«¯æ‹‰å–æ•°æ®
        fetchFromCloud();
    });

    setTimeout(() => {
        const btn = document.getElementById('btn');
        if (btn.disabled) {
            document.getElementById('status').innerText = "åŠ è½½è¶…æ—¶ï¼Œå·²åˆ‡æ¢è‡³åŸºç¡€æ¨¡å¼";
            btn.disabled = false; btn.innerText = "å¼ºåˆ¶å¯åŠ¨"; btn.onclick = onFirstClick;
        }
    }, 5000); 

    // --- 3. æ•°æ®å­˜å–æ ¸å¿ƒå‡½æ•° (Hybrid æ¨¡å¼) ---

    // ä»äº‘ç«¯æ‹‰å–æ•°æ®
    function fetchFromCloud() {
        document.getElementById('sync-status').innerText = "åŒæ­¥ä¸­...";
        
        const query = Bmob.Query("CheckInRecord");
        query.equalTo("syncCode", "==", userSyncCode);
        query.order("-createdAt");
        
        query.find().then(res => {
            // è¦†ç›–æœ¬åœ°ç¼“å­˜
            cachedList = res.map(item => {
                return {
                    objectId: item.objectId, // Bmob ID
                    name: item.name,
                    address: item.address,
                    position: item.position,
                    time: item.time
                };
            });
            
            renderCollectionList();
            renderLitMarkers();
            document.getElementById('sync-status').innerText = "å·²åŒæ­¥";
        }).catch(err => {
            console.error("äº‘ç«¯åŒæ­¥å¤±è´¥", err);
            document.getElementById('sync-status').innerText = "ç¦»çº¿æ¨¡å¼";
        });
    }

    function updateSyncCode() {
        const newCode = document.getElementById('sync-code-input').value.trim();
        if (newCode && newCode !== userSyncCode) {
            userSyncCode = newCode;
            localStorage.setItem('sz_sync_code', userSyncCode);
            alert('åŒæ­¥ç å·²æ›´æ–°ï¼æ­£åœ¨æ‹‰å–æ–°æ•°æ®...');
            fetchFromCloud(); // åˆ‡æ¢è´¦å·åï¼Œé‡æ–°æ‹‰å–
        }
    }

    function getCollection() {
        return cachedList;
    }

    // ä¿å­˜ (æœ¬åœ° + äº‘ç«¯)
    function saveToCollection(place) {
        // 1. æœ¬åœ°ç«‹å³æ›´æ–° (UI å“åº”å¿«)
        cachedList.unshift(place);
        renderCollectionList();
        renderLitMarkers();

        // 2. åå°å‘é€åˆ°äº‘ç«¯
        const query = Bmob.Query("CheckInRecord");
        query.set("syncCode", userSyncCode);
        query.set("name", place.name);
        query.set("address", place.address);
        query.set("position", place.position);
        query.set("time", place.time);
        
        query.save().then(res => {
            console.log("äº‘ç«¯ä¿å­˜æˆåŠŸ", res);
            cachedList[0].objectId = res.objectId; // å›å¡« ID
        }).catch(err => {
            console.error("ä¿å­˜å¤±è´¥", err);
        });
    }

    // åˆ é™¤ (æœ¬åœ° + äº‘ç«¯)
    function deleteFromCollection(timestamp) {
        const targetItem = cachedList.find(item => item.time === timestamp);
        
        // 1. æœ¬åœ°ç«‹å³åˆ é™¤
        cachedList = cachedList.filter(item => item.time !== timestamp);
        renderCollectionList();
        renderLitMarkers();

        // 2. äº‘ç«¯åˆ é™¤
        if (targetItem && targetItem.objectId) {
            const query = Bmob.Query("CheckInRecord");
            query.destroy(targetItem.objectId).then(res => {
                console.log("äº‘ç«¯åˆ é™¤æˆåŠŸ");
            }).catch(err => { console.error(err); });
        }
    }

    // --- æ¸²æŸ“é€»è¾‘ ---
    function renderLitMarkers() {
        map.remove(litMarkers); miniMap.remove(miniLitMarkers);
        litMarkers = []; miniLitMarkers = [];
        const list = getCollection();
        list.forEach(place => {
            const marker = new AMap.Marker({
                position: place.position,
                content: '<div class="lit-marker"></div>',
                offset: new AMap.Pixel(-7, -7), title: place.name + " (å·²ç‚¹äº®)", zIndex: 50
            });
            marker.on('click', () => {
                if (window.innerWidth < 600) {
                    showMobilePanel({
                        name: place.name, address: place.address, vibe: "å·²ç‚¹äº®", isLit: true
                    });
                } else {
                    new AMap.InfoWindow({
                        content: `<div style="padding:5px"><b>${place.name}</b><br><span style="font-size:12px;color:#999">ç‚¹äº®äº: ${new Date(place.time).toLocaleDateString()}</span></div>`,
                        offset: new AMap.Pixel(3, -20)
                    }).open(map, place.position);
                }
            });
            litMarkers.push(marker);
            const mMarker = new AMap.Marker({
                position: place.position, content: '<div class="mini-lit-marker"></div>', offset: new AMap.Pixel(-1.5, -1.5)
            });
            miniLitMarkers.push(mMarker);
        });
        map.add(litMarkers); miniMap.add(miniLitMarkers);
    }
    
    function renderCollectionList() {
        const list = getCollection();
        const container = document.getElementById('col-list');
        if (list.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999; margin-top:30px; font-size:13px;">è¿˜æ²¡ç‚¹äº®ä»»ä½•åœ°æ–¹<br>å¿«å»æ¢ç´¢å§ï¼</p>';
            return;
        }
        // æŒ‰æ—¶é—´æ’åºå·²ç»åœ¨ fetch æ—¶åšäº†ï¼Œè¿™é‡Œåªéœ€æ¸²æŸ“
        let html = '';
        list.forEach(item => {
            const dateStr = new Date(item.time).toLocaleString();
            const itemStr = encodeURIComponent(JSON.stringify(item));
            html += `
                <div class="col-item">
                    <div class="col-info">
                        <h4>${item.name}</h4>
                        <p>${item.address}</p>
                        <span class="date">${dateStr}</span>
                    </div>
                    <div class="col-actions">
                        <button class="action-btn btn-fly" onclick="flyToHistory([${item.position}])">âœˆï¸</button>
                        <button class="action-btn btn-nav-col" onclick="openNavSheetFromCol('${itemStr}')">ğŸš€</button>
                        <button class="action-btn btn-del" onclick="deleteFromCollection(${item.time})">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
    }
    function toggleCollection() { document.getElementById('collection-panel').classList.toggle('open'); }
    function flyToHistory(position) {
        map.setZoomAndCenter(17, position);
        if(window.innerWidth < 600) toggleCollection(); 
    }

    // --- å¯¼èˆª ---
    window.openNavSheet = function() {
        if (!currentTargetData) return;
        navTargetData = currentTargetData;
        showNavSheetUI();
    }
    
    window.openNavSheetFromCol = function(itemStr) {
        const item = JSON.parse(decodeURIComponent(itemStr));
        navTargetData = {
            name: item.name,
            position: { lng: item.position[0], lat: item.position[1] }
        };
        if(window.innerWidth < 600) toggleCollection(); 
        showNavSheetUI();
    }

    function showNavSheetUI() {
        const sheet = document.getElementById('nav-sheet');
        const overlay = document.getElementById('nav-overlay');
        sheet.classList.remove('closing'); sheet.classList.add('open'); overlay.classList.add('open');
    }
    
    window.closeNavSheet = function() {
        const sheet = document.getElementById('nav-sheet');
        const overlay = document.getElementById('nav-overlay');
        sheet.classList.remove('open'); sheet.classList.add('closing'); overlay.classList.remove('open');
        setTimeout(() => { sheet.classList.remove('closing'); }, 300);
    }
    
    window.startNavigation = function(type) {
        if (!navTargetData) return;
        const lng = navTargetData.position.lng; const lat = navTargetData.position.lat; const name = navTargetData.name;
        let url = '';
        if (type === 'amap') url = `https://uri.amap.com/marker?position=${lng},${lat}&name=${name}&src=ShenzhenExplorer&coordinate=gaode&callnative=1`;
        else if (type === 'apple') url = `http://maps.apple.com/?daddr=${lat},${lng}&dirflg=d&t=m`;
        window.location.href = url; closeNavSheet();
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    var district = new AMap.DistrictSearch({ subdistrict: 0, extensions: 'all', level: 'city' });
    var placeSearch = new AMap.PlaceSearch({ pageSize: 20, pageIndex: 1, extensions: 'base', type: 'é£æ™¯åèƒœ|å•†åŠ¡ä½å®…|é¤é¥®æœåŠ¡|è´­ç‰©æœåŠ¡|ç”Ÿæ´»æœåŠ¡|ä½“è‚²ä¼‘é—²æœåŠ¡|ç§‘æ•™æ–‡åŒ–æœåŠ¡' });

    district.search('æ·±åœ³å¸‚', function(status, result) {
        if(status === 'complete'){
            var bounds = result.districtList[0].boundaries;
            if (bounds) {
                for (var i = 0, l = bounds.length; i < l; i++) {
                    var mainP = new AMap.Polygon({ map: map, strokeWeight: 2, strokeColor: '#007AFF', fillColor: '#CCF3FF', fillOpacity: 0.1, path: bounds[i] });
                    mainPolygons.push(mainP);
                    var miniP = new AMap.Polygon({ map: miniMap, strokeWeight: 0, strokeColor: '#999', fillColor: '#fff', fillOpacity: 0.3, path: bounds[i] });
                    miniPolygons.push(miniP);
                    shenzhenPolygons.push(bounds[i]);
                }
                map.setFitView(mainPolygons, false, [20, 20, 150, 20]);
                miniMap.setFitView(miniPolygons, false, [10, 10, 10, 10]);
                renderLitMarkers(); renderCollectionList();
                
                document.getElementById('status').innerText = "åœ°å›¾å·²å°±ç»ªï¼Œå‡†å¤‡å‡ºå‘ï¼";
                document.getElementById('btn').disabled = false;
                document.getElementById('btn').innerText = "å¼€å§‹æ¢ç´¢";
            }
        } else {
            console.error("åŠ è½½å¤±è´¥", status);
            document.getElementById('status').innerText = "è¾¹ç•Œæ•°æ®åŠ è½½å¼‚å¸¸ï¼Œä½†å¯ä»¥ä½¿ç”¨";
            document.getElementById('btn').disabled = false;
            document.getElementById('btn').innerText = "å¼ºåˆ¶å¼€å§‹";
        }
    });

    const szBounds = [113.75, 22.45, 114.62, 22.86];

    function onFirstClick() {
        const btn = document.getElementById('btn');
        const cover = document.getElementById('cover-layer');
        const layerCtrl = document.getElementById('layer-control');
        const rightCtrl = document.getElementById('right-controls');
        
        btn.disabled = true; btn.innerText = "å¯åŠ¨å¼•æ“..."; cover.style.opacity = '0';
        setTimeout(() => {
            cover.style.display = 'none';
            layerCtrl.style.visibility = 'visible'; layerCtrl.style.opacity = '1';
            rightCtrl.style.visibility = 'visible'; rightCtrl.style.opacity = '1';
            startSearch(); btn.onclick = startSearch; 
        }, 800);
    }

    function switchMapStyle(type, btnElement) {
        var btns = document.querySelectorAll('.layer-btn');
        btns.forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        map.remove([standardLayer, satelliteLayer, roadNetLayer, trafficLayer]);
        if (type === 'satellite') map.add([satelliteLayer, roadNetLayer]);
        else if (type === 'normal') { map.add(standardLayer); map.setMapStyle('amap://styles/normal'); }
        else if (type === 'traffic') { map.add([standardLayer, trafficLayer]); map.setMapStyle('amap://styles/normal'); }
    }

    function startSearch() {
        closeNavSheet(); 
        const btn = document.getElementById('btn');
        btn.disabled = true;
        findValidPlace(0);
    }

    function findValidPlace(attempts) {
        if (window.innerWidth < 600) {
            document.getElementById('panel-content').innerHTML = `
                <h2>æ­£åœ¨æœå¯»...</h2>
                <div id="status">é›·è¾¾æ‰«æä¸­ (ç¬¬ ${attempts+1} æ¬¡)...</div>
            `;
        } else {
            const statusDiv = document.getElementById('status');
            if (attempts % 5 === 0) statusDiv.innerText = `æ­£åœ¨æ¢æµ‹çƒ­é—¹åŒºåŸŸ (ç¬¬ ${attempts + 1} æ¬¡ç­›é€‰)...`;
        }

        let validPointInPolygon = null; let polyAttempts = 0;
        if (shenzhenPolygons.length === 0) {
             let rLng = Math.random() * (szBounds[2] - szBounds[0]) + szBounds[0];
             let rLat = Math.random() * (szBounds[3] - szBounds[1]) + szBounds[1];
             validPointInPolygon = [rLng, rLat];
        } else {
            while (!validPointInPolygon && polyAttempts < 50) {
                let rLng = Math.random() * (szBounds[2] - szBounds[0]) + szBounds[0];
                let rLat = Math.random() * (szBounds[3] - szBounds[1]) + szBounds[1];
                let pt = [rLng, rLat];
                for (let i = 0; i < shenzhenPolygons.length; i++) {
                    if (AMap.GeometryUtil.isPointInRing(pt, shenzhenPolygons[i])) {
                        validPointInPolygon = pt; break;
                    }
                }
                polyAttempts++;
            }
        }
        if (!validPointInPolygon) { findValidPlace(attempts + 1); return; }

        placeSearch.searchNearBy('', validPointInPolygon, 800, function(status, result) {
            if (status === 'complete' && result.info === 'OK' && result.poiList.pois.length > 0) {
                let poiCount = result.poiList.pois.length;
                let acceptProbability = 0;
                if (poiCount >= 15) acceptProbability = 1.0; 
                else if (poiCount >= 5) acceptProbability = 0.8;
                else acceptProbability = 0.15 + (attempts * 0.02); 

                if (Math.random() < acceptProbability) {
                    let targetIndex = Math.floor(Math.random() * Math.min(poiCount, 3));
                    let targetPoi = result.poiList.pois[targetIndex]; 
                    showDestination(targetPoi.location, targetPoi.name, targetPoi.address, poiCount);
                } else { findValidPlace(attempts + 1); }
            } else { findValidPlace(attempts + 1); }
        });
    }

    // è¾…åŠ©ï¼šæ›´æ–°æ‰‹æœºé¢æ¿å†…å®¹
    function showMobilePanel(data) {
        const panelContent = document.getElementById('panel-content');
        
        let actionsHtml = '';
        if (!data.isLit) {
            actionsHtml = `
                <div class="panel-actions">
                    <button class="p-btn p-btn-check" onclick="handleCheckin()">ğŸ“ ç‚¹äº®è¿™é‡Œ</button>
                    <button class="p-btn p-btn-nav" onclick="openNavSheet()">ğŸš€ å¯¼èˆªå‰å¾€</button>
                </div>
            `;
        } else {
            actionsHtml = `
                <div class="panel-actions">
                    <button class="p-btn p-btn-nav" style="background:#007AFF" onclick="openNavSheet()">ğŸš€ å¯¼èˆªå‰å¾€</button>
                </div>
            `;
        }

        panelContent.innerHTML = `
            <div class="panel-detail-name">${data.name}</div>
            <div class="panel-detail-address">${data.address}</div>
            <div class="panel-tags">${data.vibe}</div>
            ${actionsHtml}
        `;
    }

    // è¾…åŠ©ï¼šé‡ç½®æ‰‹æœºé¢æ¿åˆ°åˆå§‹çŠ¶æ€
    function resetMobilePanel(msg) {
        document.getElementById('panel-content').innerHTML = `
            <h2>${msg || 'æ·±åœ³å»å“ªç©ï¼Ÿ'}</h2>
            <div id="status">${msg ? 'å·²è®°å½•åœ¨è¶³è¿¹ä¸­' : 'å‡†å¤‡å‡ºå‘...'}</div>
        `;
    }

    window.handleCheckin = function() {
        if (!currentTargetData) return;
        const placeData = {
            name: currentTargetData.name,
            address: currentTargetData.address,
            position: [currentTargetData.position.lng, currentTargetData.position.lat],
            time: new Date().getTime()
        };
        saveToCollection(placeData);
        
        if (currentMarker) map.remove(currentMarker);
        if (miniMarker) miniMap.remove(miniMarker);
        
        if (window.innerWidth < 600) {
            resetMobilePanel("ğŸ‰ å·²ç‚¹äº®ï¼");
        } else {
            document.getElementById('status').innerText = "ğŸ‰ å·²ç‚¹äº®ï¼ç»§ç»­ä¸‹ä¸€ä¸ªï¼Ÿ";
            map.clearInfoWindow();
        }
        
        document.getElementById('btn').innerText = "ç»§ç»­æ¢ç´¢";
    }

    function showDestination(position, name, address, density) {
        if (currentMarker) map.remove(currentMarker);
        currentTargetData = { position, name, address };
        
        currentMarker = new AMap.Marker({
            position: position,
            content: '<div class="custom-marker"></div>', 
            offset: new AMap.Pixel(-9, -9), title: name,
            animation: 'AMAP_ANIMATION_DROP', zIndex: 100
        });
        map.add(currentMarker);

        var miniMapDiv = document.getElementById('mini-map');
        miniMapDiv.style.visibility = 'visible'; miniMapDiv.style.opacity = '1';
        if (miniMarker) miniMap.remove(miniMarker);
        miniMarker = new AMap.Marker({
            position: position, content: '<div class="mini-marker"></div>', offset: new AMap.Pixel(-5, -5), zIndex: 101
        });
        miniMap.add(miniMarker);
        if (miniPolygons.length > 0) miniMap.setFitView(miniPolygons, false, [10, 10, 10, 10]);

        let vibe = "";
        if (density > 15) vibe = "ğŸ”¥ çƒ­é—¹å¸‚åŒº";
        else if (density > 5) vibe = "ğŸ˜ï¸ å®é™è¡—åŒº";
        else vibe = "ğŸŒ² éšç§˜è§’è½";
        let detail = address && address.length > 0 ? address : "é™„è¿‘æ— è¯¦ç»†é—¨ç‰Œ";
        
        let flyAltitude = 11.5; 
        
        animateView({ zoom: flyAltitude, pitch: 0 }, 800, function() {
            map.panTo(position);
            setTimeout(() => {
                animateView({ zoom: 17, pitch: 0 }, 1000, function() {
                    
                    if (window.innerWidth < 600) {
                        showMobilePanel({ name, address: detail, vibe, isLit: false });
                        map.panBy(0, -50); 
                    } else {
                        var infoWindow = new AMap.InfoWindow({
                            content: `
                                <div style="padding:5px; min-width:200px">
                                    <b style="font-size:16px">${name}</b><br>
                                    <span style="font-size:12px;color:#999; margin-bottom:5px; display:block">${vibe}</span>
                                    <span style="font-size:13px;color:#333">${detail}</span>
                                    <div class="bubble-btn-group">
                                        <button class="bubble-btn btn-checkin" onclick="handleCheckin()">ğŸ“ ç‚¹äº®è¿™é‡Œ</button>
                                        <button class="bubble-btn btn-nav" onclick="openNavSheet()">ğŸš€ å¯¼èˆªå‰å¾€</button>
                                    </div>
                                </div>`,
                            offset: new AMap.Pixel(3, -20),
                            anchor: 'bottom-center',
                            autoMove: true, 
                            closeWhenClickMap: true 
                        });
                        infoWindow.open(map, position);
                        map.panBy(0, 80);
                        document.getElementById('status').innerText = `ğŸ“ ${name}`;
                    }
                    
                    document.getElementById('btn').disabled = false;
                    document.getElementById('btn').innerText = "æ¢ä¸ªåœ°æ–¹";
                });
            }, 800); 
        });
    }    

    function animateView(target, duration, callback) {
        let startZoom = map.getZoom(); let startPitch = map.getPitch(); let startTime = performance.now();
        function step(currentTime) {
            let elapsed = currentTime - startTime;
            let progress = Math.min(elapsed / duration, 1);
            let ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
            let currentZoom = startZoom + (target.zoom - startZoom) * ease;
            let currentPitch = startPitch + (target.pitch - startPitch) * ease;
            map.setZoom(currentZoom); map.setPitch(currentPitch);
            if (progress < 1) requestAnimationFrame(step); else if (callback) callback();
        }
        requestAnimationFrame(step);
    }  
</script>
</body>
</html>
